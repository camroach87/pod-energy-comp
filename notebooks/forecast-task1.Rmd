---
title: "Task 1 forecast"
author: "Cameron Roach"
date: "22/02/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(podEnergyComp)
library(tidyverse)
library(lubridate)

fcst_start_date <- ymd("2018-10-16")
# fcst_start_date <- ymd("2018-10-02")  # TODO: DELETE ME

# load data
demand.data <- load_demand_data("../inst/extdata/pod_ds_task1")
demand.cv <- cv_ts_folds(demand.data$datetime, start_date = fcst_start_date,
                         horizon = 7, iterations = 1)

pv.data <- load_pv_data("../inst/extdata/pod_ds_task1")
pv.cv <- cv_ts_folds(pv.data$datetime, start_date = fcst_start_date,
                     horizon = 7, iterations = 1)

# fit models and predict
demand.forecast <- pred_demand(demand.data, demand.cv[[1]]$train, 
                               demand.cv[[1]]$test, lambda_l1 = 1.0)
pv.forecast <- pred_pv(pv.data, pv.cv[[1]]$train, pv.cv[[1]]$test, 
                       lambda_l1 = 2.1)

demand.pred_df <- tibble(
  datetime = getElement(demand.data[demand.cv[[1]]$test,], "datetime"),
  demand_mw = demand.forecast
)
pv.pred_df <- tibble(
  datetime = getElement(pv.data[pv.cv[[1]]$test,], "datetime"),
  pv_power_mw = pv.forecast
)
fcst_df <- full_join(pv.pred_df, demand.pred_df, by = "datetime") %>% 
  mutate(period = 2*hour(datetime) + minute(datetime)/30 + 1)

# schedule battery
b_sched <- schedule_battery(fcst_df)
bat_df <- format_charge_data(b_sched$B)

# save results
write_csv(bat_df,
          file = "../inst/extdata/pod_ds_task1/Cameron_set1.csv")
```


## Checks

```{r}
fcst_df %>% 
  select(datetime, demand_mw, pv_power_mw) %>% 
  pivot_longer(-datetime) %>% 
  ggplot(aes(x = datetime, y = value, colour = name)) +
  geom_line()

# TODO: convert these to tests that a user can run with test_schedule command
# FIXME: some rounding errors introduced when correcting for C > 6 MWh
matplot(t(b_sched$B), type = "l")
matplot(t(b_sched$C), type = "l")
table(b_sched$C[,2:32] == 0.5*t(apply(b_sched$B, 1, cumsum))[,1:31])
table(abs(b_sched$C[,2:32] - 0.5*t(apply(b_sched$B, 1, cumsum))[,1:31]) < 1e-12)
min(b_sched$B, na.rm=T) >= -2.5
max(b_sched$B, na.rm=T) <= 2.5
max(apply(t(b_sched$B[,1:31]), 2, cumsum)) <= 12
max(apply(t(b_sched$B[,1:31]), 2, cumsum)) - 12
max(b_sched$C) <= 6
min(b_sched$C) == 0
all(b_sched$B[,32:42] <= 0)
all(b_sched$B[,1:31] >= 0)

# check battery data frame
bla <- bat_df %>% 
  group_by(date = date(datetime)) %>% 
  mutate(cumsum_charge_MW = cumsum(charge_MW))
max(bla$cumsum_charge_MW) - 12 == 0

ggplot(bat_df, aes(x = datetime, y = charge_MW)) + 
  geom_line()

bat_df %>% 
  inner_join(fcst_df, by = "datetime") %>% 
  mutate(demand_red_mw = demand_mw,
         demand_red_mw = if_else(period %in% 32:42,
                                 demand_mw + charge_MW,
                                 demand_mw)) %>% 
  select(datetime, demand_mw, demand_red_mw) %>% 
  pivot_longer(cols = -datetime) %>% 
  ggplot(aes(x = datetime, y = value, colour = name)) +
  geom_line() +
  ylim(0, NA)
```
